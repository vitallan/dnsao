name: Release on main

on:
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: release-on-main
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Java 17 (Temurin) + cache Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Read revision from POM (may be -SNAPSHOT)
        id: readrev
        run: |
          echo "REVISION=$(mvn -q -DforceStdout help:evaluate -Dexpression=revision)" >> "$GITHUB_OUTPUT"

      - name: Compute release version (strip -SNAPSHOT)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          CURR="${{ steps.readrev.outputs.REVISION }}"
          if [[ ! "$CURR" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-SNAPSHOT)?$ ]]; then
            echo "Unexpected revision '$CURR'"; exit 1
          fi
          REL="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
          echo "release=$REL" >> "$GITHUB_OUTPUT"
          echo "tag=v$REL"     >> "$GITHUB_OUTPUT"

      - name: Build & Test
        run: mvn -B -q clean install

      - name: Create git tag vX.Y.Z (lightweight)
        uses: actions/github-script@v7
        with:
          script: |
            const tag  = core.getInput('tag');
            const sha  = process.env.GITHUB_SHA;
            const ref  = `refs/tags/${tag}`;
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo:  context.repo.repo,
                ref,
                sha
              });
            } catch (e) {
              if (e.status === 422 && /Reference already exists/.test(e.message)) {
                core.info(`Tag ${tag} already exists; skipping createRef`);
              } else {
                throw e;
              }
            }
          result-encoding: string
          tag: ${{ steps.ver.outputs.tag }}

      - name: Build release notes (prev tag -> current tag) preserving newlines
        id: notes
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.tag }}" 
          REL="${{ steps.ver.outputs.release }}"
          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"

          {
            echo "## DNSao ${REL}"
            echo
            if [ -n "${PREV_TAG}" ]; then
              echo "### Changes since ${PREV_TAG}"
              echo
              echo "- Compare: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG}"
              echo
              echo "#### Commits"

              git log --no-decorate --pretty=format:'- %h %s%n%b' "${PREV_TAG}..${TAG}" | sed -e 's/\r$//'
            else
              echo "### First release on this line"
              echo
              echo "#### Commits"
              git log --no-decorate --pretty=format:'- %h %s%n%b' "${TAG}" -n 200 | sed -e 's/\r$//'
            fi
            echo
          } > RELEASE_BODY.md

          echo "body_path=RELEASE_BODY.md" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: DNSao ${{ steps.ver.outputs.release }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: false
          body_path: ${{ steps.notes.outputs.body_path }}

      - name: Upload dnsao.jar to the release (rename asset)
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.ver.outputs.tag }}
          file: target/dnsao-${{ steps.readrev.outputs.REVISION }}.jar
          asset_name: dnsao.jar
          overwrite: true

      - name: Compute next SNAPSHOT (patch+1)
        id: next
        shell: bash
        run: |
          set -euo pipefail
          REL="${{ steps.ver.outputs.release }}"   # e.g., 0.1.5
          if [[ ! "$REL" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "Unexpected release '$REL'"; exit 1
          fi
          echo "next_version=${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.$((BASH_REMATCH[3]+1))-SNAPSHOT" >> "$GITHUB_OUTPUT"

      - name: Bump POM revision to next SNAPSHOT and push
        shell: bash
        run: |
          set -euo pipefail
          mvn -B -q versions:set-property \
            -Dproperty=revision \
            -DnewVersion="${{ steps.next.outputs.next_version }}" \
            -DgenerateBackupPoms=false
          
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore(release): bump revision to ${{ steps.next.outputs.next_version }} [skip ci]" || echo "nothing to commit"
          # push explicitamente para a branch main (evita ambiguidade com tags)
          git push origin HEAD:refs/heads/main